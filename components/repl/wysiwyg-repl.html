<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lightview:Sites</title>
    <script src="https://unpkg.com/@isomorphic-git/lightning-fs"></script>
    <script src="https://unpkg.com/isomorphic-git"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://unpkg.com/turndown/dist/turndown.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codeflask@1.4.1/build/codeflask.min.js" integrity="sha256-YdO3p9WDoWX5KYPzdxjQKrxt5QhTVqohfcTdrRQiB8w=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@calumk/editorjs-codeflask@1.0.9/dist/editorjs-codeflask.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/editorjs-github-gist-plugin@1.1.0/dist/main.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <template id="repl">
            <div id="content" style="min-height:100%;width:750px;max-width:750px;height:100%;border:1px solid;padding:10px;margin:0 auto">
                <div style="display:flex;flex-direction:column;">
                    <div id="tabs" style="flex-grow:0;width:100%;border:1px;padding-bottom:5px;text-align:center">
                        <span style="padding-right:10px"><label for="headhtml" l-on:click="${onTabClick}">HTML Head</label><input for="headhtml" value="${headhtmlPinned}" type="checkbox"  l-on:click="${onPinClick}"></span>
                        <span style="padding-right:10px"><label for="bodyhtml" l-on:click="${onTabClick}">HTML Body</label><input for="bodyhtml" value="${bodyhtmlPinned}" type="checkbox" l-on:click="${onPinClick}" checked></span>
                        <span style="padding-right:10px"><label for="csstext" l-on:click="${onTabClick}">Style</label><input for="csstext" value="${csstextPinned}" type="checkbox" l-on:click="${onPinClick}" checked></span>
                        <span style="padding-right:10px"><label for="scripttext" l-on:click="${onTabClick}">Script</label><input for="scripttext" value="${scripttextinned}" type="checkbox" l-on:click="${onPinClick}" checked></span>
                        <span style="padding-right:10px"><label for="preview" l-on:click="${onTabClick}">Preview</label><input for="preview" value="${previewPinned}" type="checkbox" l-on:click="${onPinClick}" checked></span>
                    </div>
                </div>
                <div id="headhtml" style="display:inline-block;border:solid 1px;height:200px;width:750px;max-height:85vh;max-width:740px;overflow:auto;margin-bottom:5px;padding-left:10px;"></div>
                <div id="bodyhtml" style="display:inline-block;border:solid 1px;height:200px;width:750px;max-height:85vh;max-width:740px;overflow:auto;margin-bottom:5px;padding-left:10px;"></div>
                <div id="csstext" style="display:inline-block;border:solid 1px;height:200px;width:260px;max-height:85vh;max-width:740px;overflow:auto;margin-bottom:5px;padding-left:10px;"></div>
                <div id="scripttext"  style="display:inline-block;border:solid 1px;height:200px;width:460px;max-height:85vh;max-width:740px;overflow:auto;margin-bottom:5px;padding-left:10px;"></div>
                <div id="preview" style="display:inline-block;border:1px solid;resize:both;height:200px;max-width:100%;width:100%;"></div>
            </div>
            <div style="width:100%;text-align:center">
                <div style="padding:5px">${source}</div>
                <button l-on:click="${doSave}">Save</button>&nbsp;&nbsp;
                <button l-if="${!source.trim().startsWith('http')}" l-on:click="${doReset}">Reset</button>
            </div>
        <style id="style">
            label:hover {
                text-decoration: underline
            }
        </style>
        <script type="lightview/module">
            const turndownService = new TurndownService({headingStyle:"atx",codeBlockStyle:"fenced",emDelimiter:"*"});
            turndownService.keep(() => true);

            const {html,css,script} = await import("../../types.js");
            self.variables({
                onTabClick:"function",
                onPinClick:"function",
                doSave: "function",
                doReset:"function"
            });
            self.variables({
                wysiwygPinned:"boolean",
                bodyhtmlPinned:"boolean",
                bodyhtml:html,
                markdownPinned:"boolean",
                markdown:html,
                csstextPinned:"boolean",
                csstext:css,
                scripttextPinned:"boolean",
                scripttext:script,
                headhtmlPinned:"boolean",
                headhtml:html,
                previewPinned:"boolean",
                source:"string",
            },{reactive});
            self.variables({
                src:"string",
            },{imported});

            bodyhtmlPinned = true;
            csstextPinned = true;
            scripttextPinned = true;
            previewPinned = true;

            const loadFromFile = async () => {
                const html = await fs.readFile(url.pathname,{encoding:"utf8"});
                source = `IndexedDB://${url.hostname+"_repl"}${url.pathname}`;
                return html;
            };

            const loadFromServer = async () => {
                const response = await fetch(url.href);
                const html = await response.text();
                source = url.href;
                return html;
            };

            const parseFullHTML = (fullHTML) => {
                const parser = new DOMParser(),
                    fragment = parser.parseFromString(fullHTML,"text/html"),
                    body_el = fragment?.querySelector("body"),
                    style_el = fragment?.querySelector("style"),
                    script_el = body_el?.querySelector("script");
                if(style_el) {
                    csstext = style_el?.innerHTML;
                    style_el.remove();
                } else {
                    csstext = "";
                }
                if(script_el) {
                    scripttext = script_el?.innerHTML,
                    script_el.remove();
                } else {
                    scripttext = "";
                }
                headhtml = fragment?.head.innerHTML || "";
                bodyhtml = body_el?.innerHTML;
            };

            let fs,
                url;
            if(src) {
                url = new URL(src,window.location.href);
                fs = new LightningFS(url.hostname+"_repl").promises;
                try {
                    parseFullHTML(await loadFromFile());
                } catch(e) {
                    try {
                        parseFullHTML(await loadFromServer());
                    } catch(e) {
                        fullHTML = e.message;
                    }
                }
            } else {
                url = new URL(window.location.href);
                fs = new LightningFS(url.hostname+"_repl").promises;
                bodyhtml = "";
                headhtml = "";
                scripttext = "";
                csstext = "";
            };

            // initialize variables
            markdown = "";

            const tabs = [...self.querySelectorAll("label[for]")]
                .map((label) => {
                    const id = label.getAttribute("for");
                    return [id,self.getElementById(id),label];
                });

            const showTab = (targetid) => {
                tabs.forEach(([id,el,label]) => {
                    if(id===targetid || self.varsProxy[`${id}Pinned`]) {
                        el.style.display = "unset";
                    } else if(!self.varsProxy[`${id}Pinned`]) {
                        el.style.display = "none";
                    }
                });
            };

            const hideTab = (targetid) => {
                tabs.forEach(([id,el,label]) => {
                    if(id===targetid) el.style.display = "none";
                });
            };

            onTabClick = (event) => {
                showTab(event.target.getAttribute("for"));
            };

            onPinClick = (event) => {
                const id = event.target.getAttribute("for"),
                    checked = self.varsProxy[`${id}Pinned`] = event.target.checked;
                if(checked) onTabClick(event);
                else hideTab(id);
            };

            doSave = async () => {
                const parts = url.pathname.split("/");
                let dir = "";
                parts.shift();parts.pop();
                for(const part of parts) {
                    dir = dir + "/" + part;
                    try {
                        await fs.mkdir(dir);
                    } catch(e) {
                        if(e.message==="EEXIST") break;
                        throw e;
                    }
                }
                fs.writeFile(url.pathname,doPreview(),{encoding:"utf8"},()=>{});
                source = `IndexedDB://${url.hostname+"_repl"}${url.pathname}`;
            };

            doReset = async () => {
                try {
                    await fs.unlink(url.pathname);
                } catch(e) {

                }
                if(src) {
                    try {
                        parseFullHTML(await loadFromServer());
                        doPreview();
                    } catch(e) {
                        previewEl.innerHTML = fullHTML = e.message;
                    }
                } else {
                    bodyhtml = "";
                    headhtml = "";
                    scripttext = "";
                    csstext = "";
                    previewEl.innerHTML = "";
                }
            };

            const doPreview = () => {
                // not quite write, createComponent needs to be reworked to handle a head and import its links
                const template = document.createElement("template");
                template.innerHTML = bodyhtmlEl.value + "<style>" + csstext + "</style>" + '<script type="lightview/module">' + scripttext + "<" + "/script>";
                const component = window.customElements.get("x-preview");
                if(component) { component.setTemplateNode(template); }
                else { Lightview.createComponent("x-preview",template); }
                previewEl.innerHTML = "<x-preview></x-preview>";
                return "<html><head>"+headhtml+"</head><body>"+template.innerHTML+"<body></html>"
            };

            const bodyhtmlEl = self.getElementById("bodyhtml"),
                headhtmlEl = self.getElementById("headhtml"),
                tabsEl = self.getElementById("tabs"),
                csstextEl = self.getElementById("csstext"),
                scripttextEl = self.getElementById("scripttext"),
                previewEl = self.getElementById("preview");

            const initEditors = () => {
                [["headhtml",headhtmlEl,"html"],["bodyhtml",bodyhtmlEl,"html"],["csstext",csstextEl,"css"],[ "scripttext",scripttextEl,"js"]].forEach(([id,target,language]) => {
                    const flask = new CodeFlask(target, { language,lineNumbers:true });
                    flask.updateCode(self.vars[id].value);
                });
            };

            self.addEventListener("connected",() => {
                initEditors();
                doPreview();
            });
        </script>
    </template>
    <script src="../../lightview.js"></script>
</head>
<body style="min-height:95vh;">
    <script>Lightview.createComponent("l-repl", document.getElementById("repl"));</script>
    <!--l-repl style="min-height:95vh" src="../../examples/counter.html"></l-repl-->
    <div id="htmlhead" style="max-width:750px;max-height:500px;height:500px;border:1px solid;resize:both" ></div>
    <div id="htmlbody" style="max-width:750px;max-height:500px;height:500px;border:1px solid;resize:both" ></div>
    <script>
        new CodeFlask('#htmlhead', {
            language: 'html',
            lineNumbers: true
        });
        new CodeFlask('#htmlbody', {
            language: 'html',
            lineNumbers: true
        });
    </script>
</body>
</html>